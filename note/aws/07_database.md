# データベース


## 目次

1. [RDS](#rds)
	1. [ストレージタイプ](#ストレージタイプ)
	1. [マルチAZ構成](#マルチaz構成)
	1. [リードレプリカ](#リードレプリカ)
	1. [バックアップとリストア](#バックアップとリストア)
	1. [RDSのセキュリティ](#rdsのセキュリティ)
	1. [Aurora](#aurora)
1. [Redshift](#redshift)
	1. [Redshiftの構成](#redshiftの構成)
	1. [列指向型データベース](#列指向型データベース)
	1. [圧縮エンコード方式への対応](#圧縮エンコード方式への対応)
	1. [ゾーンマップ](#ゾーンマップ)
	1. [Redshiftの拡張性](#redshiftの拡張性)
	1. [ワークロードの管理機能](#ワークロードの管理機能)
	1. [Redshift Spectrum](#redshift-spectrum)
1. [DynamoDB](#dynamodb)
	1. [高可用性設計](#高可用性設計)
	1. [スループットキャパシティ](#スループットキャパシティ)
	1. [データパーティショニング](#データパーティショニング)
	1. [プライマリキーとインデックス](#プライマリキーとインデックス)
	1. [TTL](#ttl)
	1. [DynamoDB Stream](#dynamodb-stream)
	1. [Consistent Read](#consistent-read)
	1. [DynamoDB Accelerator](#dynamodb-accelarator)
1. [ElastiCache](#elasticache)
	1. [Memcached版ElastiCache](#memcached版elasticache)
	1. [Redis版ElastiCache](#redis版elasticache)
1. [その他のデータベース](#その他のデータベース)
	1. [Amazon DocumentDB](#amazon-documentdb)
	1. [Amazon Keyspaces](#amazon-keyspaces)
	1. [Amazon Timestream](#amazon-timestream)
	1. [Amazon QLDB](#amazon-qldb)


## RDS

**Amazon RDS**（Relational Database Service）は、AWSが提供するマネージドRDBサービスである。データベースエンジンは、MySQL、MariaDB、PostgreSQL、Oracle、Microsoft SQL Serverなどから選択できる。また、**Amazon Aurora**はAWSが独自に開発した、クラウドのメリットを最大限生かした新しいアーキテクチャのRDSである。

### ストレージタイプ

RDSのデータ保存用のストレージには、EBSを利用する。ボリュームタイプとしては、汎用SSD、プロビジョンドIOPS SSD、マグネティックから選択することができる。

### マルチAZ構成

**マルチAZ構成**は、1つのリージョン内の2つのAZにDBインスタンスをそれぞれ配置し、障害発生時やメンテナンス時のダウンタイムを短くすることで高可用性を実現するサービス。

ただし、2つのAZ間でデータを同期するため、シングルAZ構成よりも書き込みやコミットにかかる時間が長くなる。また、**フェイルオーバ**が発生した場合に、RDSへの接続用のFQDNのDNSレコードがスタンバイ側のIPアドレスに書き換えられるが、この操作に時間がかかる点にも注意が必要である。

### リードレプリカ

**リードレプリカ**は、通常のRDSとは別に参照専用のDBインスタンスを作成することができるサービスである。マスタDBの負荷を抑えたり、読み込みが多いアプリケーションではDBリソースのスケールアウトを容易に実現することが可能となる。

マスタとリードレプリカのデータ同期は**非同期レプリケーション**方式であるため、参照されるタイミングによってはマスタ側で更新された情報が反映されていない可能性があることに注意。

### バックアップとリストア

**自動バックアップ**は、バックアップウィンドウと保持期間を指定することで、1日1回自動的にバックアップ（DBスナップショット）を取得してくれるサービス。

**手動スナップショット**は、任意のタイミングでRDBのバックアップを取得できるサービス。

**データのリストア**は、スナップショットから新規のRDSを作成することで簡単に実現できる。

**ポイントインタイムリカバリ**は、自動バックアップのスナップショットを利用して、任意のタイミングの状態のRDSを新規に作成することができるサービス。

### RDSのセキュリティ

RDSはVPCに対応しているため、インターネットに接続せずともVPC内のサービスから利用できる。セキュリティグループによる通信要件の制限も可能で、EC2やほかのAWSサービスからRDSまでの通信もデータベースエンジンが提供するSSLを使った暗号化に対応している。

また、RDSの暗号化オプションを有効にすることで、データが保存されるストレージやスナップショット、ログなどのRDSに関連するすべてのデータが暗号化された状態で保持される。

### Aurora

**Amazon Aurora**は、AWSが開発したデータベースエンジン。DBインスタンスを作成すると同時に**DBクラスタ**が作成される。DBクラスタは、1つ以上のDBインスタンスと、各DBインスタンスから参照するデータストレージ（**クラスタボリューム**）で構成される。クラスタボリュームは単一のリージョン内の3つのAZにそれぞれ2つのデータコピーで構成され、各ストレージ間のデータは自動的に同期される。

**Auroraレプリカ**は通常のリードレプリカと違い、Auroraのプライマリインスタンスに障害が発生した場合にレプリカインスタンスがプライマリインスタンスに昇格することでフェイルオーバを実現する。

Auroraには次のような種類のエンドポイントが存在する。**クラスタエンドポイント**は、Auroraクラスタのうち、プライマリインスタンスに接続するためのエンドポイント。**読み取りエンドポイント**は、Auroraクラスタのうち、レプリカインスタンスに接続するためのエンドポイントで、参照のみを受け付ける。**インスタンスエンドポイント**は、Auroraクラスタの各DBインスタンスに接続するためのエンドポイント。また、Auroraクラスタのうち任意のインスタンスをグルーピングして**カスタムエンドポイント**としてアクセスすることも可能である。


## Redshift

**Amazon Redshift**は、AWSが提供する**データウェアハウス**（データの分析に最適化されたソフトウェア）向けのデータベースサービス。大量のデータから意思決定に役立つ情報を見つけ出すために必要な環境を安価で準備できる。

### Redshiftの構成

Redshiftは、複数ノードによる分散並列実行が大きな特徴として挙げられる。1つのRedshiftを構成する複数のノードのまとまりを**Redshiftクラスタ**と呼び、クラスタは1つの**リーダノード**と複数の**コンピュートノード**から構成される。

**リーダノード**では、SQLクライアントやBI（Business Intelligence）ツールからの実行クエリを受け付けて、クエリの解析や実行プランの作成を行う。

**コンピュートノード**では、リーダノードからの実行クエリを処理する。各コンピュートノードはストレージとセットになっている。

**ノードスライス**は、Redshiftが分散並列処理をする最小の単位で、コンピュートノードの中でさらにリソースを分割して**スライス**という単位を構成する。

いかにコンピュートノードをまたがずに処理を完結させることができるのかがRedshift利用のポイントとなる。

### 列指向型データベース

データウェアハウスでは、大量のデータに対して集計処理を実行することがメインとなる。必要なデータに効率的にアクセスできる仕組みはパフォーマンスの観点から非常に重要である。

**列指向型（カラムナ）データベース**は、集計処理に使われるデータをまとめて列単位で管理し、ストレージからのデータ取得を効率化する。

### 圧縮エンコード方式への対応

列ごとに様々な圧縮エンコード方式が指定可能なため、データの性質に合った方式を選択することができる。

### ゾーンマップ

Redshiftではブロック単位でデータが格納される。1ブロックの容量は1MB。**ゾーンマップ**とは、そのブロック内に格納されているデータの最小値と最大値をメモリに保存する仕組み。ゾーンマップにより、データ検索条件に該当する値の有無を効率的に判断できるため、処理が高速化される。

### Redshiftの拡張性

**MPP**（Massively Parallel Processing）は、1回の集計処理を複数のノードに分散して実行する仕組み。ノードを追加（スケールアウト）するだけで分散並列処理のパフォーマンスを向上させる。

**シェアードナッシング**は、各ノードがディスクを共有せず、ノードとディスクセットで拡張する仕組み。複数のノードが共通のディスクを共有することによるI/O性能の劣化を回避するために採用されている。

### ワークロードの管理機能

Redshiftでは、多種多様なデータ解析要求を効率的に処理するための管理（Workload Management、WLM）機能が用意されている。Redshiftのパラメータグループにある**wlm_json_configuration**パラメータでクエリの実行に関する定義が可能である。

### Redshift Spectrum

**Redshift Spectrum**は、S3に置かれたデータを外部テーブルとして定義できるようにし、Redshift内にデータを取り込むことなくクエリの実行を可能にする拡張サービス。


## DynamoDB

**Amazon DynamoDB**は、AWSが提供する**Key-Value型**のマネージドNoSQLデータベースサービス。テーブルやインデックスを作成する際に、読み取り・書き込みに必要なスループットを指定してリソースを確保することで、安定した性能を担保する仕組み。**トランザクション**機能にも対応している。

- 高い信頼性と拡張性を必要とするシステム
- スループットが増減するようなピーク帯のあるシステム
- 大量のデータを蓄積して高速な検索が可能なシステム
- 広告やゲームなどのユーザの行動履歴を管理するシステム
- Webアプリケーションの永続的セッションデータベース

### 高可用性設計

DynamoDBはデータが自動的に3つのAZに保存される仕組みになっており、単一障害点を持たない構成であるため、非常に可用性が高いサービスである。

### スループットキャパシティ

**Read Capacity Unit**（RCU）は、読み取りのスループットキャパシティを指定する指標。1RCUは、最大4KBの項目に対して、1秒当たり1回の強力な整合性のある読み取り性能、あるいは1秒当たり2回の結果的に整合性のある読み取り性能を担保することを示す。

**Write Capacity Unit**（WCU）は、書き込みのスループットキャパシティを指定する指標。1WCUは、最大1KBの項目に対して、1秒当たり1回の書き込み性能を担保することを示す。

DynamoDBでは、負荷の状況に応じてスループットキャパシティを自動的に増減することができる。急激なスループットの上昇に即座に対応できるわけではないため、事前にスパイクが発生することがわかっている場合は手動でキャパシティを拡張して対応する。

### データパーティショニング

DynamoDBはデータを**パーティション**という単位で分散保存する。1つのパーティションに保存できる容量やスループットキャパシティが決まっているため、データの増加や指定したスループットのサイズによって最適化された状態を保つように自動的にパーティションを拡張する。

### プライマリキーとインデックス

**プライマリキー**はデータ項目を一意に特定するための属性。**パーティションキー**単独のものとパーティションキーとソートキーの組み合わせで構成される**複合キーテーブル**の2種類がある。

プライマリキーはインデックスとしても利用される。**セカンダリインデックス**を作成することも可能。**ローカルセカンダリインデックス**（LSI）は、プライマリキーはテーブルで指定したパーティションキーと同じで、別の属性をソートキーとして作成するインデックス。**グローバルセカンダリインデックス**（GSI）は、プライマリキーとは異なる属性を使ってインデックスを作成し、別のキャパシティユニットでスループットを指定する。

### TTL

DynamoDB内の各項目には有効期限を設定することができ、自動メンテナンス（Time to Live、**TTL**）によってデータ削除の操作が行われる。

### DynamoDB Streams

**DynamoDB Streams**は、DynamoDBに対して行われた直近24時間の追加・更新・削除の変更履歴を保持する機能。

### Consistent Read

DynamoDBは結果整合性のデータモデルであるが、**Consistent Read**オプションを有効にすると、参照のリクエストがあった時点よりも前に書き込まれているデータがすべて反映された状態のデータをもとに参照結果を消す。RCUが2倍消費される点には注意が必要。

### DynamoDB Accelerator

**DynamoDB Accelerator**（DAX）は、DynamoDBの前段にキャッシュクラスタを構成する拡張サービス。


## ElastiCache

**Amazon ElastiCache**は、AWSが提供するインメモリ型データベースサービス。高頻度で参照するデータや検索に時間がかかるデータセットをメモリ上に保持することでパフォーマンスを向上させる。

**Memcached**は、KVS（Key-Valueストア）型インメモリデータベースのデファクトスタンダードとして広く利用されているエンジン。データの永続性機能はないため、メンテナンスや障害による再起動時にすべてのデータが消去される。

**Redis**は、Memcached同様にKVS型インメモリデータベースで、より多くのデータが扱え、キャッシュ用としてだけではなくメッセージブローカーやキューを構成する要素としても利用される。ノード間のレプリケーション機能やデータ永続性機能といった可用性も考慮された機能が実装されている。

### Memcached版ElastiCache

Mmecachedクラスタは、最大20のElastiCacheインスタンスで構成される。

クラスタを作成すると、**ノードエンドポイント**と**設定エンドポイント**の2種類のアクセスエンドポイントが作成される。

スケーリングは、**スケールアウト**、**スケールイン**、**スケールアップ**、**スケールダウン**によって行われる。

### Redis版ElastiCache

RedisではマルチAZ構成を作成することができ、マスタインスタンスが障害状態になったときはスタンバイインスタンスがマスタインスタンスに昇格する。

**クラスタモード無効**の場合、キャッシュはすべて1つのElastiCacheインスタンスに保存される。同じデータを持つリードレプリカを作成でき、マスタインスタンスとリードレプリカのまとまりを**シャード**と呼ぶ。

**クラスタモード有効**の場合、複数のシャードに分割してデータを保存する構成が可能となる。

クラスタを作成すると、**ノードエンドポイント**と**プライマリエンドポイント**、**設定エンドポイント**が作成される。

Redisはシングルスレッドのため、1コアで動作する。コア数の多いインスタンスタイプを使用してもCPU使用率が低くなってしまう点に注意する。

また、Memcached版にはデータ暗号化の機能はないが、RedisはクライアントとElastiCache間の通信とElastiCache内に保存するデータの暗号化をサポートしている。


## その他のデータベース

### Amazon Neptune

**Amazon Neptune**は、フルマネージドなグラフデータベースサービス。

**グラフデータベース**は、ノード、エッジ、プロパティの3つの要素で構成される。ネットワーク型のデータ構造で、FacebookやTwitterのようなソーシャルグラフのような繋がりの関係を表現するのに適している。それ以外にも、経路検索や購入履歴からのレコメンデーションなどにも利用される。

### Amazon DocumentDB

**Amazon DocumentDB**は、フルマネージドなMongoDB互換のドキュメントデータベースのサービス。

### Amazon Keyspaces

**Amazon Keyspaces**は、フルマネージドなApache Cassandra互換のデータベースサービス。

**Cassandra**は列指向データと行指向データの両方の特徴を兼ね備えているので、検索性も高く任意のデータをまとめて取ってくるといったことも得意としている。

### Amazon Timestream

**Amazon Timestream**は、フルマネージドな**時系列データベース**サービス。時系列データベースとは、時系列データを扱うことに特化したデータベース。

**時系列データ**とは、サーバのメモリやCPUなどの利用状況の推移や、気温の移り変わりなど、時間的に変化していく情報を持つデータ。

### Amazon QLDB

**Amazon QLDB**（Quantum Ledger Database）は、フルマネージドな台帳データベースサービス。

**台帳データベース**とは、変更履歴などをすべて残し、かつその履歴を検索可能な状態にするもの。
