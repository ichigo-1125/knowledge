# コンピューティング


## 目次

1. [EC2](#ec2)
	1. [EC2における性能](#ec2における性能)
	1. [EC2における費用](#ec2における費用)
	1. [スポットインスタンスとリザーブドインスタンス](#スポットインスタンスとリザーブドインスタンス)
	1. [インスタンスの分類と用途](#インスタンスの分類と用途)
	1. [Savings Plans](#savings-plans)
1. [ELB](#elb)
	1. [スケールアップとスケールアウト](#スケールアップとスケールアウト)
	1. [ELBの種類](#elbの種類)
	1. [ステートレス性の確保](#ステートレス性の確保)
1. [Auto Scaling](#auto-scaling)
	1. [スケーリングポリシー](#スケーリングポリシー)
	1. [猶予期間](#猶予期間)
	1. [ウォームアップとクールダウン](#ウォームアップとクールダウン)
	1. [ライフサイクルフック](#ライフサイクルフック)
	1. [終了ポリシー](#終了ポリシー)
1. [ECS](#ecs)
	1. [その他のコンテナサービス](#その他のコンテナサービス)
1. [Lambda](#Lambda)


## EC2

**Amazon Elastic Compute Cloud**（EC2）は仮想サーバを提供するコンピューティングサービス。**インスタンス**という単位でサーバが管理され、CLIからコマンド1つでインスタンスが生成できる。

インスタンス生成時には、元となる**イメージ**を選ぶ。このイメージを**AMI**（Amazon Machine Image）と呼ぶ。

### EC2における性能

EC2では**インスタンスタイプ**という形でインスタンスのスペックを選択することができる。インスタンスタイプの先頭には**インスタンスファミリー**がついており、何に最適化されたインスタンスタイプであるのかといった[分類](#インスタンスの分類と用途)を示す。コンピューティングに最適化されたインスタンスは`c`から始まり、メモリに比重を置くインスタンスタイプは`r`から始まる、といった具合。インスタンスファミリーの後ろの数字は**世代**を表す。`xlarge`や`8xlarge`は**インスタンスサイズ**を表し、大きいものほどスペックが高い。

**EBS最適化インスタンス**のオプションを有効にすると、通常のネットワーク帯域とは別に、EBS用の帯域が確保される。**EBS**（Elastic Block Store）はAWSのディスク機能であり、ディスクIOが頻繁なシステムでは採用することで帯域が足りなくなることを防げる。

### EC2における費用

EC2は**従量課金型**のサービスで、インスタンスタイプやリージョンと、インスタンスがRunning状態だった時間でコストが決まる。

インスタンスには起動中（**Running**）、停止中（**Stopped**）、削除済み（**Terminated**）の3つがある。

### スポットインスタンスとリザーブドインスタンス

[EC2における費用](#ec2における費用)は、**オンデマンドインスタンス**という通常の利用形態の場合のものである。

**スポットインスタンス**は、AWSが余らせているEC2リソースを入札形式で安く利用する形式。ただし、他の利用者からの利用リクエストが増え、余剰なリソースがなくなってしまうと、自動的にインスタンスが中断される。開発用や学習用に相性のよいオプションといえる。

**リザーブドインスタンス**（RI）は、長期間利用することを約束することで割引を受けられるオプション。インスタンスタイプを固定してしまうことになるので、サービスのリリース後、安定してきてから購入することを検討するのがよい。

**スケジュールされたリザーブドインスタンス**は、1年間のうちに毎日、毎週、毎月の一定時間のみ使うというパターンで、平日日中のみ使う場合に利用料が削減できる可能性がある。ただし、対象インスタンスは限られている。

### インスタンスの分類と用途

インスタンスタイプは次のように分類される。

- **汎用**<br>利用範囲が広い、CPUとメモリのバランス型。
- **コンピューティング最適化**<br>CPUの性能が高いもの。`C`系インスタンス。
- **メモリ最適化**<br>メモリ容量が大きいもの。`R`系インスタンスなど。
- **高速コンピューティング**<br>GPUなどCPU以外の計算リソースが強化されている。画像処理用の`P`系や機械学習用の`G`系など。
- **ストレージ最適化**<br>HDDを利用する`D`系、SSDを利用する`I`系など。

### Savings Plans

[リザーブドインスタンス](#スポットインスタンスとリザーブドインスタンス)より柔軟な割引を享受できる、**Savings Plans**というサービスが提供されている。Savings Plansには、Compute Savings PlansとEC2 Instance Savings Plansがある。

**Compute Savings Plans**は、リージョンやインスタンスファミリーと関係なく、単位時間当たりの利用料を指定して購入する。**Lambda**や**Fargate**も対象となっている。


## ELB

### スケールアップとスケールアウト

リリースしたサービスの人気が出て、インスタンスタイプをより高性能なものに変更することを、**スケールアップ**という。

スケールアップには限界があり、また、**単一障害点**（**SPOF**）となってしまう懸念もある。そこで、EC2のインスタンスを水平に並べる**スケールアウト**がよく用いられる。これは、EC2を複数並べてその前段にロードバランサを配置することで、リクエストを分散させる。

### ELBの種類

AWSで提供されているロードバランサとして、**Elastic Load Balancing**（**ELB**）がある。

- **Classic Load Balancer**（**CLB**）<br>L4-L7レイヤでの負荷分散を行う。
- **Application Load Balancer**（**ALB**）<br>L7レイヤでの負荷分散を行う。
- **Network Load Balancer**（**NLB**）<br>L4レイヤでの負荷分散を行う。HTTP以外のプロトコルの通信の負荷分散をしたい場合に利用する。

ELBは負荷に応じて自動的にEC2を段階的にスケールする設計になっている。このスケールには多少の時間がかかるため、急激な負荷増（**スパイク**）が予想される場合にはプレウォーミング申請が必要となる。

また、ELBはEC2の**ヘルスチェック**を行い、異常なインスタンスを自動的に切り離す機能もある。

### ステートレス性の確保

ELBを利用する際には、サーバが**ステートレス**になるように設計する必要がある。ステートレス性を保つため、データはデータベースに、ファイルはインスタンス外のストレージとしてS3に置く、といった具合に設計することで特定のインスタンスのみに依存する状態を作らないようにする。


## Auto Scaling

**Auto Scaling**は、システムの利用状況に応じて自動的にELBに紐づくインスタンスの台数を増減させる（スケールアウト/スケールイン）機能。

Auto Scalingを利用することで、耐障害性の向上につながる。例として、インスタンスの最小・最大台数をどちらも2つにしていた場合に1つのインスタンスが停止したとする。インスタンスの最小台数は2台であるので、Auto Scalingにより自動的にインスタンスの数がキープされる。

### スケーリングポリシー

スケーリングには、動的なスケーリング、予測スケーリング、スケジュールスケーリングがある。動的なスケーリングには、次のような種類のスケーリングポリシーがある。

**簡易スケーリング**は、「CPU使用率が70%を超えたらスケールアウトする」といったように、1つのメトリクスに対して1つの閾値を設定してスケーリングを行う。

**ステップスケーリング**は、1つのメトリクスに対して複数の閾値を設定することで、段階的にスケーリングの設定ができる。

**ターゲット追跡スケーリング**では、1つのメトリクスに目標値を設定する。例えば「CPUの使用率を50%に保つ」といった具合に目標値を設定すると、Auto Scaling全体でCPU使用率が50%を維持できるように動的にスケーリングされる。

### 猶予期間

AutoScalingには、スケールアウトによる新しいインスタンスの起動中に、別の新たなインスタンスが起動されてしまうことを防ぐための仕組みがある。

ヘルスチェックにより異常のあるインスタンスがあった場合には新しいインスタンスが起動されてしまうため、スケールアップ中は一時的にヘルスチェックを停止する**猶予期間**が設けられている。

### ウォームアップとクールダウン

**スケーリングクールダウン**は、Auto Scalingが発動した直後に追加でインスタンスの増減がなされるのを防ぐための設定である。起動指示直後の待ち時間を設けることで、複数の**アラート**がきても次々にインスタンスが立ち上がることを防ぐ。

**ウォームアップ**は、新しいインスタンスがサービスを開始してからトラフィックを受信できるようになるまでの期間。ステップスケーリングにおいて1つ目のスケーリングポリシーによってインスタンスが起動している途中で、2つ目のスケーリングポリシーによってインスタンスが追加されるときに、その差分のインスタンスのみを追加するための機能である。

### ライフサイクルフック

**ライフサイクルフック**は、Auto Scalingによるインスタンスの起動・削除時に、インスタンスを一時停止してカスタムアクションを実行する機能。インスタンスの削除時のログやデータの退避などに利用される。

### 終了ポリシー

負荷に応じてインスタンスを増やす**スケールアウト**に対して、負荷が下がったときにインスタンスを減らすことを**スケールイン**と呼ぶ。このスケールインの設定を行うのが**終了ポリシー**である。


## ECS

**ECS**（Amazon Elastic Container Service）は、Dockerコンテナ環境を提供するサービス。EC2にDockerソフトウェアの導入作業や継続したメンテナンス作業などを加えたもので、その管理をAWSがサポートしてくれる。

EC2インスタンス上で実行されるコンテナのことを**Task**と呼び、EC2インスタンスのことを**Cluster**（docker-composeのようなもの）と呼ぶ。1つのCluster上では複数のTaskを実行することができる。Cluster上で動作するTaskの定義は**Task Definition**で行う。**Service**は1つ以上の同じTaskをまとめたもので、ELBによって負荷分散をする際には、EC2の代わりにServiceを指定する。

また、セキュリティ面では、Taskごとに**IAM**（Identity and Access Management）ロールを割り当てられるという特徴がある。EC2ではインスタンス単位でしか設定できないという違いがある。

### その他のコンテナサービス

**AWS Fargate**はEC2を用いずにコンテナを動かすことのできるサービス。ECSでTask Definitionを行う際に、起動タイプをEC2とFargateから選択することができる。Fargateを選択すると、Clusterの管理が必要なくなる。

**Kubernetes**は、コンテナ管理の自動化のためのオープンソースプラットフォームである。従来、KubernetesをAWSで利用するには、マスター用のEC2インスタンスを複数台用意して管理する必要がある。**EKS**（Amazon Elastic Container Service for Kubernetes）は、このマスターをServiceとして提供するもの。

また、Dockerのレジストリサービスとして、**ECR**（Amazon  Elastic Container Registry）がある。

## Lambda

**AWS Lambda**は、サーバを**プロビジョニング**しなくてもプログラムを実行できるコンピューティングサービスで、**サーバレスアーキテクチャ**の中核を担う存在である。利用者はソースコードだけを用意すればすぐにプログラムが実行できる。

Lambdaは**Lambda関数**という単位で、実行するプログラムとその実行トリガーとなるイベントを事前に定義する。Lambda関数を実行することを、**キック**するという。

対応している言語は以下の通り。

- Node.js
- Python
- Java
- RUby
- C#
- Go
- PowerShell

Lambdaの料金体系は、リクエストの数と処理時間によって決まる。
