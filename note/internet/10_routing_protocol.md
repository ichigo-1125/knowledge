# ルーティングプロトコル


## 目次

1. [経路制御](#経路制御)
1. [経路を制御する範囲](#経路を制御する範囲)
	1. [自立システムとルーティングプロトコル](#自立システムとルーティングプロトコル)
	1. [EGPとIGP](#egpとigp)
1. [経路制御アルゴリズム](#経路制御アルゴリズム)
	1. [メトリック](#メトリック)
	1. [距離ベクトル型](#距離ベクトル型)
	1. [リンク状態型](#リンク状態型)
1. [RIP](#rip)
	1. [RIP2](#rip2)
1. [OSPF](#ospf)
	1. [OSPFの基礎知識](#ospfの基礎知識)
	1. [OSPFの階層化](#ospfの階層化)
1. [BGP](#bgp)
	1. [BGPとAS番号](#bgpとas番号)
	1. [経路ベクトル型](#経路ベクトル型)
1. [MPLS](#mpls)


## 経路制御

ルーターが正しい方向へパケットを転送するための処理を、**経路制御**や**ルーティング**と呼ぶ。ルーターは**経路制御表**（**ルーティングテーブル**）を参照してパケットを転送する。

経路制御表の作成には、**スタティックルーティング**（静的経路制御）と**ダイナミックルーティング**（動的経路制御）がある。


## 経路を制御する範囲

### 自律システムとルーティングプロトコル

経路制御に関するルールを決めて、それをもとに運用する範囲を**自律システム**（**AS**: Autonomous System）や、**経路制御ドメイン**（Routing Domain）という。これは、同一の決まりや考え方（ポリシー）によって経路制御を管理する単位のこと。

### EGPとIGP

ルーティングプロトコルは大きく**EGP**（Exterior Gateway Protocol）と**IGP**（Interior Gateway Protocol）に分けられる。EGPはAS間の経路制御に利用され、IGPはドメイン内のルーティングプロトコルとして利用される。

この階層関係は、IPアドレスのネットワーク部とホスト部の関係に似ている。


## 経路制御アルゴリズム

### メトリック

**メトリック**とは、経路制御で使われる距離やコストなどの、転送の判断に使われる指標のこと。

### 距離ベクトル型

**距離ベクトル型**（Distance-Vector）のアルゴリズムでは、物理的な距離と方向によってネットワークやホストの位置を決定する。メトリックは通過するルーターの数。

### リンク状態型

**リンク状態型**（Link-State）のアルゴリズムでは、ルーターがネットワーク全体の接続状態を理解して経路制御表を作成する。すべてのルーターが同じ情報を持ち、安定した経路制御を行うことができる。


## RIP

**RIP**は距離ベクトル型のルーティングプロトコルで、経路制御情報を定期的（30秒周期）にネットワーク上にブロードキャストする。メトリックの単位はホップ数（通過するルーターの数）で、できるだけ少ないホップ数で目的のIPアドレスに到達できるように制御される。

ルーターが接続切れなどの影響により、過去に伝えた情報を逆に教えられ、それをお互いに伝えあってしまう問題を**無限カウント**（Counting to Infinity）という。無限カウントを解決するために、経路情報を教えられたインタフェースには教えられた経路情報を流さない**スプリットホライズン**（Split Horizon）などの対策がある。

しかし、ループのあるネットワークにおいてはこういった方法を用いても無限カウントが発生してしまう。そこで、これを解決するためにポイズンリバースとトリガードアップデートという方法が利用される。

**ポイズンリバース**（Poisoned Reverse）は、経路が切れたとき、その情報を流さないのではなく、通信不能であることを表す距離16を流す。

**トリガードアップデート**（Triggered Update）は、情報が変化したとき30秒待たずにすぐに伝える方法。

### RIP2

**RIP2**はRIPを改良したプロトコルで、マルチキャスト対応、サブネットマスク対応とかなり実用的になっている。また、1つのネットワーク上で論理的に独立した複数のRIPが使えるようになっており、認証キーにも対応している。


## OSPF

**OSPF**はリンク状態型のルーティングプロトコル。ループのあるネットワークでも安定した経路制御を行うことができる。

RIPではホップ数が最も少ない方向に経路を設定するが、OSPFでは各リンクに重みをつけることができ、この重みが小さくなるように経路を選択する。この重みのことを**コスト**といい、メトリックとしてこのコストが使われる。

### OSPFの基礎知識

OSPFでは、同一リンクに接続されているルーターを**隣接ルーター**（Neighboring Router）と呼ぶ。すべての隣接ルーター間で経路情報が交換されるわけではなく、**指名ルーター**（Designated Router）を決めることができ、そのルーターを中心に経路制御情報が交換される。

OSPFでは、接続の確認をするプロトコルを**HELLOプロトコル**という。接続が切れたり回復したりといった接続状態の変化があった場合には、**リンク状態更新パケット**（Link State Update Packet）を送信して、ネットワーク状態の変化を伝える。これにより伝えられる情報は大きく2つあり、**ネットワークLSA**はそのネットワークにはどのルーターが接続されているかということを表した情報、**ルーターLSA**はそのルーターにはどのネットワークが接続されているかということを表した情報である。この更新情報が送られてきたルーターは、**リンク状態データベース**（Link State Database）を作成し、それをもとに経路制御表を作成する。経路制御表の作成には、**ダイクストラ法**という最短経路を求めるためのアルゴリズムが用いられる。

### OSPFの階層化

OSPFでは計算の負荷軽減のため、**エリア**という概念が取り入れられている。**エリア**は、ネットワーク同士やホスト同士をまとめてグループ化したもの。

各AS内には複数のエリアが存在できるが、必ず**バックボーンエリア**が必要で、各エリアはこのバックボーンエリアに接続されている必要がある。エリアとバックボーンエリアを結ぶルーターを**エリア境界ルーター**、エリア内のルーターを**内部ルーター**、バックボーンエリアにのみ接続されているルーターを**バックボーンルーター**、外部と接続しているルーターを**AS境界ルーター**と呼ぶ。

エリア境界ルーターが1つしかない場合には、そのエリアは**スタブエリア**と呼ばれ、経路情報を減らすことができる。


## BGP

### BGPとAS番号

**BGP**は組織間を接続するときに利用されるプロトコルで、EGPに分類される。

ISPや地域ネットワークなどの組織を束ねるネットワーク集団を1つの自律システムとして取り扱い、それぞれの自律システムに16ビットの**AS番号**を割り当てる。

### 経路ベクトル型

BGPにより経路制御情報を交換するルーターを**BGPスピーカー**という。

BGPでは、目的とするネットワークアドレスにパケットを送った場合に、そこに到達するまでのAS番号のリストが作られる。これを**AS経路リスト**（AS Path List）と呼ぶ。 BGPのメトリックの単位はASとなる。

BGPのように、通過する経路のリストで経路制御を行うプロトコルを**経路ベクトル型**（Path Vector）という。


## MPLS

IPパケットの転送には、ルーティングだけでなく**ラベルスイッチング**という技術も利用されている。これは、それぞれのIPパケットに**ラベル**という別の値を設定し、そのラベルに基づいて転送するというもの。

**MPLS**はラベルスイッチングの代表例で、MPLS機能に対応したルーターを**LSR**（Label Switching Router）と呼ぶ。特に外部のネットワークとの接続部分にあたるエッジのLSRを**LER**（Label Edge Router）という。

ラベルを付けてフォワーディングする動作を**Push**、ラベルを付け替えてフォワーディングする動作を**Swap**、ラベルを外してフォワーディングする動作を**Pop**という。

MPLSでは宛先が同じであるパケット（**FFC**（Forwarding Equivalence Class））は、どれもラベルによって決まる同一の経路を通る。この経路を**LSP**（Label Switching Path）と呼ぶ。
