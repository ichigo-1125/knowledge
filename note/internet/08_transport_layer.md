# トランスポート層


## 目次

1. [トランスポート層の役割](#トランスポート層の役割)
	1. [TCPとUDP](#tcpとudp)
	1. [ソケット](#ソケット)
1. [ポート番号](#ポート番号)
1. [UDP](#udp)
1. [TCP](#tcp)
	1. [コネクション](#コネクション)
	1. [シーケンスと確認応答](#シーケンスと確認応答)
	1. [コネクション管理](#コネクション管理)
	1. [TCPのデータ送信単位](#tcpのデータ送信単位)
	1. [ウィンドウ制御](#ウィンドウ制御)
	1. [フロー制御](#フロー制御)
	1. [ふくそう制御](#ふくそう制御)
	1. [Nagleアルゴリズム](#nagleアルゴリズム)
	1. [遅延確認応答](#遅延確認応答)
	1. [ピギーバック](#ピギーバック)
1. [その他のトランスポートプロトコル](#その他のトランスポートプロトコル)
	1. [QUIC](#quic)
	1. [SCTP](#sctp)
	1. [DCCP](#dccp)
	1. [UDP-Lite](#udp-lite)
1. [UDPのヘッダフォーマット](#udpのデータフォーマット)
1. [TCPのヘッダフォーマット](#tcpのデータフォーマット)


## トランスポート層の役割

トランスポート層は、通信するプログラムを指定する役割を持つ。この役割を実現するのに用いられるのが、**ポート番号**である。ポート番号により、トランスポート層の上位層のアプリケーション層で処理を行うプログラムを識別する。

### TCPとUDP

**TCP**（Transmission Control Protocol）はコネクション型で、信頼性のあるストリーム型のプロトコル。**ストリーム**とは、切れ目のないデータ構造のこと。

**UDP**（User Datagram Protocol）はコネクションレス型で、信頼性のないデータグラム型のプロトコル。

TCPとUDPには優劣があるわけではなく、TCPは信頼性のある通信が必要である場合に、UDPは高速性やリアルタイム性を重視する通信や同報通信を行いたい場合に利用する。

### ソケット

アプリケーションからTCPやUDPを利用するときには、プログラミングの開発環境やOSが用意しているライブラリを利用することになる。このようなライブラリを一般に**API**（Application Programming Interface）と呼ぶ。

TCPやUDPを利用して通信するときには、**ソケット**と呼ばれるAPIが広く使われている。アプリケーションはソケットを利用して、通信相手のIPアドレスやポート番号の設定、データの送受信の要求を行う。


## ポート番号

**ポート番号**は、同一のコンピュータ内で通信を行っているプログラムを識別するときに利用される識別子。

ポート番号には、標準で決められている**ウェルノウンポート番号**（Well-known Port Number）があり、これは0～1023の番号が割り当てられている。例として、HTTPでは80番、SMTPは25番を利用するのが一般的である。ウェルノウンポート番号以外にも、1024～49151は正式に登録されているポート番号となっている。

サーバーはポート番号が決まっている必要があるが、サービスを受ける側のポート番号は必ずしも決まっている必要はない。OSが動的に管理するポート番号は49152～65535となっている。

また、1024～65535のポートを**エフェメラルポート**（動的ポート）という。

TCPとUDPでは同じポート番号を別の目的で使用することができる（物理層のMACアドレス、ネットワーク層のIPアドレス、トランスポート層のポート番号などの識別子すべてを合わせてひとつの識別子として扱われるため）。


## UDP

**UDP**は複雑な制御は提供せず、IPを用いてコネクションレスの通信サービスを提供する。UDPは次のような用途に向いている。

- 総パケット数が少ない通信（DNS、SNMPなど）
- 動画や音声などのマルチメディア通信（即時性が必要な通信）
- LANなどの特定のネットワークに限定したアプリケーションの通信
- 同報性が必要な通信（ブロードキャスト、マルチキャスト）


## TCP

**TCP**は高信頼性の通信を提供する。ネットワークの途中でパケットが喪失した場合の再送制御や、順序が入れ替わった場合の順序制御などを行う。TCPは次のような用途に向いている。

- 信頼性が必要な通信
- インターネットを介して大量のデータを転送する場合
- ビデオオンデマンドやライブ配信といった、即時性がそれほど必要ない動画や音声の再生（**ストリーミング**）

※ストリーミング： 動画や音声のデータをダウンロードしながら再生する仕組み。再生するデータを数秒～数十秒分バッファに格納しながら再生を行うことで、パケット喪失時でも映像を止めることなく再生できる。

### コネクション

**コネクション**とは、2つのアプリケーションが情報の伝達のために専有して使用する仮想的な通信路。**バーチャルサーキット**（仮想回線）とも呼ばれる。

### シーケンスと確認応答

TCPでは、送信したデータが受信ホストに到達したとき、受信ホストは送信ホストに対してデータが到達したことを知らせる。これを、（肯定）**確認応答**（**ACK**）という。

データが正しく伝わらなかった場合には、そのことを相手に伝える**否定確認応答**（**NACK**）を行う。

受信ホストは、送信ホストの再送処理などにより、重複したデータを受け取る可能性があるため、これを識別して破棄するために**シーケンス番号**を用いる。シーケンス番号は確認応答としても用いられる。

ある一定時間内に確認応答が返ってこない場合には、データが喪失したと判断してもう一度同じデータを送信する。OSのタイマーを用いて一定時間が経過したことを、**タイムアウト**という。確認応答の到着を待つ時間を**再送タイムアウト時間**という。この再送タイムアウト時間を決めるために、パケットを送信するたびに通信の往復時間（**ラウンドトリップ時間**）とその**揺らぎ**（ラウンドトリップ時間の分散で、**ジッタ**とも呼ぶ）を計算する。

### コネクション管理

TCPはデータ送信前にTCPヘッダだけからなるコネクション確立要求のパケット（**SYNパケット**）を送信する。TCPではコネクションを確立するために、合計で3つのパケットをやり取りするため、これを**スリーウェイハンドシェイク**と呼ぶ。

また、コネクションの切断処理には**FINパケット**を用いる。

### TCPのデータ送信単位

TCPはコネクションの確立時に、通信を行うデータ単位を決定する。これを**最大セグメント長**（**MSS**: Maximum Segment Size）と呼ぶ。

MTUはIPヘッダを含めた転送最大サイズを表すが、MSSはTCPを含めない（ペイロードの）最大サイズを表す。

### ウィンドウ制御

TCPは、パケットのラウンドトリップ時間が長くなると通信性能が悪くなる。そこで**ウィンドウ**という、確認応答を待たずに複数のセグメントを送信する概念を取り入れている。この時のデータの大きさを**ウィンドウサイズ**と呼ぶ。確認応答を受信するたびに、順次複数のセグメントを並列的に送信して通信性能を向上させる仕組みを、**スライディングウィンドウ制御**という。

ウィンドウ制御では、一度受け取った確認応答と同じものを3回連続で（3セグメント分連続で）受け取った場合には、その確認応答が示しているデータを再送する。これを**高速再送制御**といい、これはタイムアウトによる再送制御よりも高速に動作する。

### フロー制御

TCPでは送信側は受信側の受信能力に合わせてパケット送信量を制御する。これを**フロー制御**という。

受信ホストは、受信可能なバッファサイズをTCPヘッダのフィールドに入れて送信ホストに送る。このフィールドの値が大きいほどスループットが大きく、高い効率での通信が可能になる。

受信ホストはバッファがいっぱいになると、送信ホストに対してデータの送信停止を要求する。停止したデータのやり取りを再開するために、送信ホストは**ウィンドウプローブ**と呼ばれるセグメントを時々送信する。

### ふくそう制御

最初からネットワークに大量のデータを送信すると、ネットワークが混雑してふくそう状態に陥る可能性がある。

これを防ぐため、TCPでは通信開始時に**スロースタート**と呼ばれるアルゴリズムを用いて送信量の制御を行う。

送信側で、データの送信量を調節するための**ふくそうウィンドウ**を定義する。スロースタートをする場合にはふくそうウィンドウのおおきさを1セグメントに設定してパケットを送信し、確認応答されるたびに1セグメントずつこれを大きくしていく。タイムアウトによる再送時には、このふくそうウィンドウを1にしてから再度スロースタートをやり直す。

このような制御によって、**バースト**（連続的にパケットを送信すること）なトラフィックを減らす。

### Nagleアルゴリズム

**Nagleアルゴリズム**は、ネットワークの利用効率を高めるためにTCPで用いられているアルゴリズム。その瞬間に送信側に送信すべきデータがあったとしてもそのデータが少ない場合にはすぐに送信せずに、送信を遅延させる。

通信が遅延してほしくない場合には、このアルゴリズムを無効にする。

### 遅延確認応答

データを受信したホストがすぐに確認応答をすると、受信バッファがいっぱいになっていて、小さなウィンドウを返す可能性がある。このような問題を**シリーウィンドウシンドローム**（SWS: Silly Window Syndrome）と呼ぶ。

そこで、データを受信してもすぐに確認応答をせずに、遅延させる**遅延確認応答**が使われている。

### ピギーバック

アプリケーションプロトコルによっては、送信したメッセージに対して相手が処理をして返事を返す場合がある。このような通信の場合に、確認応答と返事のデータパケットを1つのパケットとして送る、**ピギーバック**を用いることができる。


## その他のトランスポートプロトコル

### QUIC

**QUIC**（Quick UDP Internet Connection）はGoogleによって提案され、標準化が進められているプロトコル。TCPには暗号化の機能はないが、QUICはそれ自体で暗号化通信を可能にする。

QUICはUDPを使用するため、UDPとQUICを合わせてトランスポートプロトコルの役割を果たす。QUICの特徴は以下の通り。

- 認証、暗号化
- 低遅延のコネクション管理
- 多重化（1コネクションで複数のストリームを同時に扱う）
- 高精度な再送処理
- コネクションのマイグレーション（IPアドレスが変わってもコネクションを維持する）

### SCTP

**SCTP**（Stream Control Transmission Protocol）はTCPと同様、データの到達に関する信頼性を提供するプロトコル。

**マルチホーミング機能**（複数のNICが付いているホストで、NICが変わっても通信が継続できる）が特徴的。

### DCCP

**DCCP**（Datagram Congestion Control Protocol）は、UDPを補うプロトコルとして登場した。

UDPと同様にデータの到達性に関する信頼性はないが、コネクション型でコネクションの確立と切断に関する信頼性を持つ。

### UDP-Lite

**UDP-Lite**（Lightweight UDP）は、UDPとほぼ同じ機能を提供する。

UDPでは、チェックサムによりエラーが発生すると、パケット全体が破棄される。UDP-Liteでは、チェックサムを計算する範囲をアプリケーションが決めることができる。


## UDPのヘッダフォーマット


## TCPのヘッダフォーマット
