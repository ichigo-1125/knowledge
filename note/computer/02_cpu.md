# CPU


## 目次

- [CPUの構成要素](#cpuの構成要素)
	- [レジスタの種類](#レジスタの種類)
- [プログラムが動く仕組み](#プログラムが動く仕組み)
	- [条件分岐と繰り返しの仕組み](#条件分岐と繰り返しの仕組み)
	- [関数呼び出しの仕組み](#関数呼び出しの仕組み)
	- [配列の仕組み](#配列の仕組み)


## CPUの構成要素

CPUは**マシン語**となったプログラムの内容を解釈して実行する装置で、その実体は数百万〜数億個のトランジスタから構成された**IC**（Integrated Circuit、集積回路）と呼ばれる電子部品である。。

**レジスタ**は、処理対象となる命令やデータを格納する領域で、CPUには数個〜数十個ほどのレジスタが含まれる。

**制御装置**は、メモリ上の命令やデータをレジスタに読み出し、命令の実行結果に応じてコンピュータ全体を制御する。

**演算装置**は、メモリからレジスタに読み出されたデータを演算する役目を持つ。

**クロック**は、CPUが動作するタイミングとなる**クロック信号**（クロックパルス）を発生させる。クロック周波数が大きいほどCPUの動作は速くなる。


### レジスタの種類

C言語やJavaといった**高水準言語**で作成されたプログラムは**コンパイル**されてマシン語になり、CPUの内部でレジスタを使った処理に変換される。CPUの種類が異なれば、その内部にあるレジスタの数や種類、レジスタに格納できる値のサイズなどが異なる。

| レジスタの種類         | 役割                                                     |
| ---------------------- | -------------------------------------------------------- |
| アキュムレータ         | 演算を行うデータ及び演算後のデータを格納する。           |
| フラグ・レジスタ       | 演算処理後のCPUの状態を格納する。                        |
| プログラム・カウンタ   | 次に実行する命令が格納されたメモリのアドレスを格納する。 |
| ベース・レジスタ       | データ用のメモリの領域の先頭アドレスを格納する。         |
| インデックス・レジスタ | ベース・レジスタからの相対アドレスを格納する。           |
| 汎用レジスタ           | 任意のデータを格納する。                                 |
| 命令レジスタ           | 命令そのものを格納する。CPUが内部的に使用する。          |
| スタック・レジスタ     | スタック領域の先頭アドレスを格納する。                   |


## プログラムが動く仕組み

WindowsやLinuxなどの**OS**は、ユーザからプログラムの起動が指示されると、**ハードディスク**に保存されているプログラムを**メインメモリ**にコピーする。その後、CPUのレジスタのひとつである**プログラム・カウンタ**の値を0100に設定し、プログラムの実行を開始する。CPUが1つの命令を実行すると、プログラム・カウンタの値が自動的にひとつ増加する。

このように、プログラム・カウンタがプログラムの流れを決めている。

### 条件分岐と繰り返しの仕組み

プログラムの流れには、「順次進行」「条件分岐」「繰り返し」の3種類がある。

**順次進行**とは、アドレスの値の順に命令を実行することである。

**条件分岐**とは、条件に応じて任意のアドレスの命令を実行することである。

**繰り返し**とは、同じアドレスの命令を何度か繰り返し実行することである。

プログラム中に条件分岐や繰り返しがある場合は、プログラム・カウンタの値を任意のアドレスに設定することになる。アセンブラの**ジャンプ命令**は、直前に行なわれた演算の結果を参照して、ジャンプするかを判断する。**フラグ・レジスタ**は直前に実行した演算の結果として、アキュムレータや汎用レジスタの値が負、ゼロ、正のいずれになったかを記憶する役割を持つ（**オーバフロー**、**パリティチェック**の結果なども記憶）。

### 関数呼び出しの仕組み

関数を呼び出す際には、プログラム・カウンタの値を関数が格納された値に設定する。関数呼び出しでは、関数の呼び出しが完了したら関数の呼び出し元に戻ってこなければいけないため、単純なジャンプ命令は使えない。

この問題を解決するためには、**コール命令**と**リターン命令**が用いられる。**コール命令**では、関数の入口のアドレスをプログラム・カウンタに設定する前に、関数呼び出しの次に実行すべき命令のアドレスをメインメモリ上の**スタック**領域に保存する。関数の処理が終了したら、関数の最後で**リターン命令**を実行し、スタックに保存されたアドレスをプログラム・カウンタに設定する。

### 配列の仕組み

配列は同じサイズのデータがメモリ上に連続して並んだデータ構造のことで、**ベース・レジスタ**と**インデックス・レジスタ**によって実現されている。

CPUはベース・レジスタの値を配列の先頭アドレスとし、インデックス・レジスタの分だけずれた要素（インデックスで指定された要素）を参照する。
